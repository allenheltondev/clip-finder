AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  Resources necessary for running the app

Parameters:
  Connection:
    Type: String

Resources:
  ClipFinderBucket:
    Type: AWS::S3::Bucket
    Properties:
      AccessControl: Private

  AppRunnerRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: ['tasks.apprunner.amazonaws.com']
            Action: ['sts:AssumeRole']
      Path: /
      Policies:
        - PolicyName: ClipFinderAppRunnerRole
          PolicyDocument:
            Statement:
            - Effect: Allow
              Action:
                - s3:GetObject
                - s3:PutObject
              Resource:
                - !GetAtt ClipFinderBucket.Arn
                - !Sub ${ClipFinderBucket.Arn}/*
            - Effect: Allow
              Action:
                - transcribe:GetTranscriptionJob
                - transcribe:ListTranscriptionJobs
              Resource: '*'
            - Effect: Allow
              Action:
                - transcribe:StartTranscriptionJob
              Resource: !Sub arn:${AWS::Partition}:transcribe:${AWS::Region}:${AWS::AccountId}:transcription-job/*

  TranscribeRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: ['transcribe.amazonaws.com']
            Action: ['sts:AssumeRole']
      Path: /
      Policies:
        - PolicyName: ClipFinderAppRunnerRole
          PolicyDocument:
            Statement:
            - Effect: Allow
              Action:
                - s3:GetObject
                - s3:PutObject
                - s3:ListBucket
              Resource:
                - !Sub ${ClipFinderBucket.Arn}/*

  AppRunnerService:
    Type: AWS::AppRunner::Service
    Properties:
      SourceConfiguration:
        AuthenticationConfiguration:
          ConnectionArn: !Ref Connection
        AutoDeploymentsEnabled: true
        CodeRepository:
          CodeConfiguration:
            ConfigurationSource: REPOSITORY
          RepositoryUrl: https://github.com/allenheltondev/clip-finder
          SourceCodeVersion:
            Type: BRANCH
            Value: main
      InstanceConfiguration:
        InstanceRoleArn: !GetAtt AppRunnerRole.Arn

  DoTheRestOfItFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../functions/generate-email
      Handler: index.handler
      Timeout: 300
      MemorySize: 1024
      Runtime: nodejs20.x
      Architectures:
        - arm64
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action: bedrock:InvokeModel
              Resource: '*'
            - Effect: Allow
              Action: s3:GetObject
              Resource: !Sub ${ClipFinderBucket.Arn}/*
            - Effect: Allow
              Action: events:PutEvents
              Resource: !Sub arn:${AWS::Partition}:events:${AWS::Region}:${AWS::AccountId}:event-bus/default
      Environment:
        Variables:
          AWS_NODEJS_CONNECTION_REUSE_ENABLED: 1
          BUCKET_NAME: !Ref ClipFinderBucket
      Events:
        TranscriptionSuccessful:
          Type: EventBridgeRule
          Properties:
            Pattern:
              source:
                - aws.transcribe
              detail-type:
                - Transcribe Job State Change
              detail:
                TranscriptionJobStatus:
                  - COMPLETED

